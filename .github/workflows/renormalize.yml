name: Renormalize repository line endings

# Run manually from the Actions tab (workflow_dispatch)
on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch to open PR against'
        required: true
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  renormalize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Ensure .gitattributes exists (if you haven't already added one)
        run: |
          if [ ! -f .gitattributes ]; then
            echo "* text=auto" > .gitattributes
            git add .gitattributes
            git commit -m "Add .gitattributes (auto text)" || echo "no commit"
          else
            echo ".gitattributes already exists"
          fi

      - name: Renormalize all files
        run: |
          git add --renormalize .
          # if there are no changes, exit early
          if git diff --staged --quiet && git diff --quiet; then
            echo "No changes after renormalize"
            exit 0
          fi
          BRANCH="renormalize-$(date +%s)"
          git checkout -b "$BRANCH"
          git commit -m "Renormalize repository line endings"
          git push origin "$BRANCH"

          # Create a PR via GitHub API
          BASE="${{ github.event.inputs.base_branch }}"
          PR_TITLE="Renormalize repository line endings"
          PR_BODY="This PR was generated by GitHub Actions to renormalize line endings after updating .gitattributes."
          API_URL="https://api.github.com/repos/${{ github.repository }}/pulls"
          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL" \
            -d "{\"title\":\"${PR_TITLE}\",\"head\":\"${BRANCH}\",\"base\":\"${BASE}\",\"body\":\"${PR_BODY}\"}" \
            | jq -r '.html_url // "PR created (no URL returned)"' || echo "PR creation may have failed"

      - name: Done
        run: echo "Renormalize job finished"
